<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saveetha Timetable Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Palette (improved contrast) */
      --bg-primary: #051127; /* deep blue */
      --bg-secondary: #0b1630; /* card/secondary bg */
      --bg-card: rgba(11, 22, 48, 0.92);
      --border: #293447; /* subtle border */
      --text-primary: #e6eef8; /* pale text */
      --text-secondary: #98a6bf; /* secondary */
      --accent: #3b82f6; /* blue accent */
      --accent-hover: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.12);
      --warning-border: rgba(245, 158, 11, 0.4);
      --danger: #ef4444;
      --cell-occupied: #1e40af; /* stronger blue */
      --cell-empty: rgba(5,17,39,0.6);
      --input-bg: #081222; /* explicit input background */
      --control-radius: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, var(--bg-primary), #031022 140%);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px;
      background: var(--bg-secondary);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .header h1 {
      font-size: 2.5rem; font-weight: 700; margin-bottom: 10px;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }

    .header p { 
      color: var(--text-secondary); 
      font-size: 1.05rem; 
      max-width: 800px; 
      margin: 0 auto; 
      line-height: 1.4;
      text-align: center;
    }

    .header p span {
      display: block;
      text-align: center;
      margin: 5px auto 0;
      font-size: 0.9em;
      opacity: 0.9;
    }

    .wizard-steps {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 40px;
    }

    .step-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      color: var(--text-secondary);
    }

    .step-circle.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }

    .step-circle.completed {
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      color: white;
      border-color: transparent;
    }

    .step-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    @media (min-width: 768px) {
      .step-label {
        display: block;
      }
    }

    .wizard-container { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 40px; }

    .card { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); padding: 30px; backdrop-filter: blur(8px); }

    h2 { 
      font-size: 1.5rem; 
      font-weight: 600; 
      margin-bottom: 20px; 
      color: var(--text-primary); 
      display:flex; 
      align-items:center; 
      gap:10px; 
    }
    .status.warning {
      color: var(--warning);
    }

    
    /* NEW: Title with toggle on right side */
    .title-with-toggle {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 20px;
      margin-bottom: 25px;
    }

    .title-with-toggle h2 {
      margin: 0;
    }

    .title-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .constraints-toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.03);
      padding: 8px 15px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .constraints-toggle-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    /* Toggle Switch Styles - smaller version */
    .constraints-toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .constraints-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .constraints-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, #ef4444, #f59e0b);
      transition: .4s;
      border-radius: 34px;
    }
    
    .constraints-toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    .constraints-toggle input:checked + .constraints-toggle-slider {
      background: linear-gradient(90deg, #10b981, #3b82f6);
    }
    
    .constraints-toggle input:checked + .constraints-toggle-slider:before {
      transform: translateX(26px);
    }
    
    .constraints-toggle-status {
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 65px;
      text-align: center;
    }
    
    .constraints-toggle-status.strict {
      color: #ef4444;
    }
    
    .constraints-toggle-status.flexible {
      color: #10b981;
    }

    /* Subject list */
    .subject-selection-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 1024px) { .subject-selection-container { grid-template-columns: 2fr 1fr; } }

    .subject-list { background: transparent; border: 1px solid var(--border); border-radius: 12px; padding: 15px; max-height: 500px; overflow-y: auto; }

    .subject-search { margin-bottom: 15px; }
    .subject-search input {
      width: 100%; padding: 12px 16px; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: var(--control-radius); font-size: 0.95rem; font-family: inherit;
    }
    .subject-search input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 6px rgba(59,130,246,0.06); }

    .subject-item {
      padding: 12px 16px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.15s ease; display:flex; justify-content:space-between; align-items:center;
    }
    .subject-item:hover { border-color: var(--accent); transform: translateY(-2px); }
    .subject-item.selected { background: linear-gradient(90deg, rgba(59,130,246,0.12), rgba(139,92,246,0.06)); border-color: rgba(59,130,246,0.6); }

    .subject-code { font-weight: 700; color: var(--text-primary); }
    .subject-name { font-size: 0.9rem; color: var(--text-secondary); margin-top: 2px; }

    .subject-sections { font-size: 0.85rem; background: rgba(255,255,255,0.02); padding: 4px 8px; border-radius: 6px; margin-left: 10px; color: var(--text-secondary); }

    /* Selected subjects panel */
    .selected-subjects { background: transparent; border: 1px solid var(--border); border-radius: 12px; padding: 15px; max-height: 500px; overflow-y: auto; }
    .selected-subjects h3 { font-size: 1.1rem; margin-bottom: 15px; }

    .selected-subject-item { padding: 12px 16px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }

    .remove-subject { background: var(--danger); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.85rem; }
    .remove-subject:hover { background: #dc2626; }

    .empty-state { 
      text-align: center; 
      padding: 40px 20px; 
      color: var(--text-secondary); 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .empty-state svg {
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* Constraints grid */
    .constraints-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
      gap: 15px; 
      margin-bottom: 25px;
    }
    
    .constraint-group { 
      background: transparent; 
      padding: 12px; 
      border-radius: 10px; 
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .constraint-group label { 
      font-size: 0.9rem; 
      margin-bottom: 8px; 
      color: var(--text-secondary); 
      display:block; 
    }

    /* Staff preferences - SEPARATE COLUMNS FOR EACH SUBJECT */
    .staff-preferences { 
      margin-top: 25px; 
      padding-top: 20px; 
      border-top: 1px solid var(--border); 
    }
    
    .staff-pref-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .staff-pref-title {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 300px;
    }
    
    .staff-strictness-toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.03);
      padding: 10px 15px;
      border-radius: 12px;
      border: 1px solid var(--border);
      min-width: 280px;
      justify-content: space-between;
    }
    
    .staff-strictness-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    /* Toggle Switch Styles */
    .staff-strictness-toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .staff-strictness-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .staff-strictness-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, #ef4444, #f59e0b);
      transition: .4s;
      border-radius: 34px;
    }
    
    .staff-strictness-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    .staff-strictness-toggle input:checked + .staff-strictness-slider {
      background: linear-gradient(90deg, #10b981, #3b82f6);
    }
    
    .staff-strictness-toggle input:checked + .staff-strictness-slider:before {
      transform: translateX(30px);
    }
    
    .staff-strictness-status {
      font-size: 0.85rem;
      font-weight: 600;
      min-width: 70px;
      text-align: center;
    }
    
    .staff-strictness-status.strict {
      color: #ef4444;
    }
    
    .staff-strictness-status.flexible {
      color: #10b981;
    }
    
    .staff-pref-subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    
    /* Columns for each subject */
    .staff-columns-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .staff-column {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 500px;
    }
    
    .staff-column-header {
      background: rgba(255,255,255,0.03);
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .staff-column-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    
    .staff-subject-code {
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .staff-subject-name {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .staff-column-count {
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .staff-column-content {
      padding: 15px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
    
    /* Staff chips */
    .staff-chips-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .staff-chip { 
      padding: 12px 15px; 
      background: rgba(255,255,255,0.02); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      cursor: grab; 
      font-size: 0.9rem; 
      transition: all 0.15s ease; 
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      user-select: none;
      width: 100%;
    }
    
    .staff-chip:hover { 
      border-color: var(--accent); 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .staff-chip.dragging {
      opacity: 0.5;
      background: linear-gradient(90deg, rgba(59,130,246,0.2), rgba(139,92,246,0.1));
    }
    
    .staff-chip.selected { 
      background: linear-gradient(90deg, rgba(59,130,246,0.15), rgba(139,92,246,0.08)); 
      border-color: rgba(59,130,246,0.6); 
      color: var(--accent); 
    }
    
    .staff-order-badge {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .staff-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    
    .staff-name {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .staff-count { 
      font-size: 0.75rem; 
      background: rgba(255,255,255,0.05); 
      padding: 2px 6px; 
      border-radius: 4px; 
      margin-left: auto;
      flex-shrink: 0;
    }
    
    .staff-remove {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      color: var(--danger);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.9rem;
      flex-shrink: 0;
      transition: all 0.15s ease;
      opacity: 0;
    }
    
    .staff-chip:hover .staff-remove {
      opacity: 1;
    }
    
    .staff-remove:hover {
      background: rgba(239,68,68,0.2);
    }
    
    .drag-indicator {
      color: var(--text-secondary);
      opacity: 0.5;
      flex-shrink: 0;
    }
    
    .staff-chip:hover .drag-indicator {
      opacity: 1;
    }
    
    .empty-column {
      color: var(--text-secondary);
      font-style: italic;
      padding: 40px 20px;
      text-align: center;
      border: 2px dashed var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,0.01);
    }
    
    /* Staff action buttons */
    .staff-actions {
      margin-top: 25px;
      display: flex;
      gap: 10px;
    }
    
    .staff-action-btn {
      flex: 1;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s ease;
    }
    
    .staff-action-btn:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    
    .staff-action-btn.clear {
      background: rgba(239,68,68,0.1);
      color: var(--danger);
      border-color: rgba(239,68,68,0.3);
    }
    
    .staff-action-btn.clear:hover {
      background: rgba(239,68,68,0.2);
    }

    /* Styled selects (fixes white background issue & contrast) */
    .styled-select {
      -webkit-appearance: none; appearance: none; background-color: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border); padding: 10px 14px; border-radius: 10px; width: 100%; font-size: 1rem; cursor: pointer; background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23AAB8D6'><path d='M5.23 7.21a.75.75 0 011.06.02L10 10.939l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z'/></svg>");
      background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; transition: border-color .15s ease, box-shadow .15s ease;
    }
    .styled-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 6px rgba(59,130,246,0.06); }
    .constraint-group select { font-family: inherit; }
    .styled-select option { background: var(--bg-secondary); color: var(--text-primary); }

    /* Selected summary cards */
    .selected-summary { background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 1px solid var(--border); }
    .selected-cards { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      align-items: center;
    }
    .subject-card { background: linear-gradient(90deg,var(--accent), #8b5cf6); color: white; padding: 8px 16px; border-radius: 8px; display:flex; align-items:center; gap:8px; font-size:0.9rem; }
    .subject-card .remove-btn { background: rgba(255,255,255,0.18); border:none; color:white; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:0.9rem; }

    /* Wizard nav */
    .wizard-navigation { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin-top: 30px; 
      gap: 20px; 
    }
    .wizard-btn { 
      padding: 14px 28px; 
      background: var(--bg-secondary); 
      color: var(--text-primary); 
      border:1px solid var(--border); 
      border-radius: 12px; 
      font-size:1rem; 
      font-weight:500; 
      cursor:pointer; 
      display:flex; 
      align-items:center; 
      gap:10px; 
      white-space: nowrap;
    }
    .wizard-btn.primary { background: linear-gradient(135deg, var(--accent), #8b5cf6); border:none; color:white; }
    .wizard-btn:disabled { opacity:0.5; cursor:not-allowed; }

    /* Results */
    .results { margin-top: 40px; }
    .timetable-table { width:100%; border-collapse: collapse; font-size:0.9rem; }
    .timetable-table th { background: var(--bg-primary); color: var(--text-secondary); font-weight:500; text-transform:uppercase; letter-spacing:0.05em; font-size:0.8rem; padding:12px 8px; border:1px solid var(--border); text-align:center; }
    .timetable-table td { padding:12px 8px; border:1px solid var(--border); text-align:center; vertical-align: middle; font-size:0.85rem; }
    .timetable-table td.day-header { background: var(--bg-primary); font-weight:600; text-align:left; color: var(--text-primary); }
    .timetable-table td.occupied { background: var(--cell-occupied); color: white; }
    .timetable-table td.empty { background: var(--cell-empty); color: var(--text-secondary); }

    .legend { display:flex; gap:20px; justify-content:center; margin-top:20px; padding:15px; background: var(--bg-secondary); border-radius:10px; border:1px solid var(--border); }
    .legend-item { display:flex; align-items:center; gap:8px; font-size:0.9rem; color: var(--text-secondary); }
    .legend-color { width:20px; height:20px; border-radius:4px; }
    .legend-color.occupied { background: var(--cell-occupied); }
    .legend-color.empty { background: var(--cell-empty); border:1px solid var(--border); }

    /* Status / messages */
    .status { 
      margin-top: 20px; 
      color: var(--text-secondary); 
      text-align: center;
      padding: 10px;
      border-radius: 8px;
    }
    .status.loading { color: var(--text-secondary); }
    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }

    /* Spinner animation */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Priority Mode Selector */
    .priority-mode-selector {
      margin: 30px 0;
      padding: 25px;
      background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1));
      border-radius: 14px;
      border: 2px solid rgba(59,130,246,0.3);
    }
    
    .priority-mode-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .priority-mode-header h4 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .priority-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .priority-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .priority-option:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .priority-option.selected {
      background: linear-gradient(90deg, rgba(59,130,246,0.15), rgba(139,92,246,0.1));
      border-color: rgba(59,130,246,0.8);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }
    
    .priority-radio {
      accent-color: var(--accent);
      margin-top: 3px;
    }
    
    .priority-info {
      flex: 1;
    }
    
    .priority-title {
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
      display: block;
      font-size: 1rem;
    }
    
    .priority-description {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    
    .priority-badge {
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 10px;
    }

    /* Warning Display */
    .staff-warnings-container {
      margin: 20px 0;
      padding: 20px;
      background: linear-gradient(135deg, var(--warning-bg), rgba(245,158,11,0.06));
      border: 2px solid var(--warning-border);
      border-radius: 14px;
    }
    
    .warnings-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .warnings-icon {
      background: var(--warning);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .warning-item {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(245,158,11,0.1);
      border-radius: 10px;
      border-left: 4px solid var(--warning);
    }
    
    .warning-subject {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .warning-subject-code {
      background: linear-gradient(90deg, var(--warning), #f97316);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .warning-content {
      color: #92400e;
    }
    
    .warning-staff-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .warning-staff-badge {
      background: rgba(245,158,11,0.2);
      color: #92400e;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .header h1 { font-size: 2rem; }
      .header p { font-size: 1rem; }
      .card { padding: 20px; }
      .constraints-grid { grid-template-columns: 1fr; }
      .timetable-table { font-size: 0.8rem; }
      .timetable-table th, .timetable-table td { padding:8px 4px; }
      .wizard-steps { flex-direction:column; align-items:center; gap:10px; }
      .staff-columns-container {
        grid-template-columns: 1fr;
      }
      .staff-chip {
        flex-wrap: wrap;
        gap: 8px;
      }
      .staff-pref-header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      .staff-strictness-toggle-container {
        width: 100%;
        justify-content: space-between;
      }
      .staff-actions {
        flex-direction: column;
      }
      .priority-options {
        grid-template-columns: 1fr;
      }
      .title-with-toggle {
        flex-direction: column;
        align-items: flex-start;
      }
      .wizard-navigation {
        flex-direction: column;
        gap: 10px;
      }
      .wizard-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 10px; height:10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius:5px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    svg { width:16px !important; height:16px !important; }
</style>
</head>
<body>
    <header class="header">
      <!-- ADD THIS LOGOUT BUTTON DIV -->
      <div style="position: absolute; top: 20px; right: 20px;">
        <button onclick="logout()" 
          style="background: #ef4444; color: white; border: none; padding: 8px 16px; 
                  border-radius: 6px; cursor: pointer; font-weight: 500; 
                  text-decoration: none; display: inline-block;">
          Logout
        </button>
      </div>
      <h1>SCHEDULA MATRIX GENERATOR</h1>
      <p>FlexiLearn made it complex. I make it clear</p>
      <p><span>~ a Fitboy Product</span></p>
    </header>

    <!-- Wizard Steps Indicator -->
    <div class="wizard-steps">
      <div class="step-indicator">
        <div id="step1Circle" class="step-circle active">1</div>
        <span class="step-label">Select Subjects</span>
      </div>
      <div class="step-indicator">
        <div id="step2Circle" class="step-circle">2</div>
        <span class="step-label">Set Constraints</span>
      </div>
    </div>

    <!-- Page 1 -->
    <div id="page1" class="wizard-page active">
      <div class="card">
        <h2>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
          Step 1: Select Your Subjects
        </h2>

        <div class="subject-selection-container">
          <div class="subject-list">
            <div class="subject-search">
              <input type="text" id="subjectSearch" placeholder="Search subjects...">
            </div>
            <div id="allSubjectsList"></div>
          </div>

          <div class="selected-subjects">
            <h3>Selected Subjects <span id="selectedCount">(0)</span></h3>
            <div id="selectedSubjectsList">
              <div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><p>No subjects selected yet. Click on subjects from the left list to add them.</p></div>
            </div>
          </div>
        </div>

        <div class="wizard-navigation">
          <div></div>
          <button id="nextToPage2" class="wizard-btn primary">Continue to Constraints <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
        </div>
      </div>
    </div>

    <!-- Page 2 -->
    <div id="page2" class="wizard-page" style="display:none;">
      <div class="card">
        <!-- NEW: Title with toggle on right side -->
        <div class="title-with-toggle">
          <div class="title-left">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
            <h2>Step 2: Set Constraints & Generate</h2>
          </div>
          
          <div class="constraints-toggle-container">
            <span class="constraints-toggle-label">Constraints:</span>
            <label class="constraints-toggle">
              <input type="checkbox" id="constraintsStrictnessToggle" checked>
              <span class="constraints-toggle-slider"></span>
            </label>
            <span id="constraintsStrictnessStatus" class="constraints-toggle-status strict">STRICT</span>
          </div>
        </div>

        <div class="selected-summary">
          <h3>Selected Subjects</h3><br>
          <div id="selectedSubjectsSummary" class="selected-cards"></div>
          <div class="wizard-navigation" style="margin-top:20px;"><button id="backToPage1" class="wizard-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back to Subject Selection</button></div>
        </div>

        <div class="constraints-grid">
          <div class="constraint-group"><label>Morning Classes</label><select id="allow_morning" class="styled-select">
<option value="less">Prefer fewer morning classes</option><option value="anything" selected>Anything (allow morning)</option><option value="no">No morning classes</option><option value="yes">Allow morning</option></select></div>
          <div class="constraint-group"><label>Evening Classes</label><select id="allow_evening" class="styled-select">
<option value="less">Prefer fewer evening classes</option><option value="anything" selected>Anything (allow evening)</option><option value="no">No evening classes</option><option value="yes">Allow evening</option></select></div>
          <div class="constraint-group"><label>Saturday Classes</label><select id="allow_sat" class="styled-select"><option value="anything" selected>Anything (allow Saturday)</option><option value="no">No Saturday classes</option><option value="yes">Allow Saturday</option></select></div>
          <div class="constraint-group"><label>Max Classes/Day</label><select id="max_classes" class="styled-select"><option value="anything" selected>Unlimited</option><option value="1">1 class per day</option><option value="2">2 classes per day</option><option value="3">3 classes per day</option><option value="4">4 classes per day</option></select></div>
          <div class="constraint-group"><label>Free Day Required</label><select id="need_free_day" class="styled-select"><option value="no" selected>No free day needed</option><option value="yes">Need a free day</option></select></div>
          <div class="constraint-group"><label>Free Day Choice</label><select id="free_day" class="styled-select"><option value="">No preference</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option></select></div>
        </div>

        <!-- SEPARATE COLUMNS FOR EACH SUBJECT -->
        <div class="staff-preferences">
          <div class="staff-pref-header">
            <div class="staff-pref-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              <h3>Staff Preferences (Drag to reorder priority)</h3>
            </div>
            
            <div class="staff-strictness-toggle-container">
              <span class="staff-strictness-label">Staff:</span>
              <label class="staff-strictness-toggle">
                <input type="checkbox" id="staffStrictnessToggle">
                <span class="staff-strictness-slider"></span>
              </label>
              <span id="staffStrictnessStatus" class="staff-strictness-status flexible">FLEXIBLE</span>
            </div>
          </div>
          
          <p class="staff-pref-subtitle">
            <strong>STRICT mode:</strong> Only uses your preferred staff. If no preferred staff meet time constraints, falls back to available staff with warning.<br>
            <strong>FLEXIBLE mode:</strong> Considers both preferred AND leftover staff. Timetables with preferred staff are ranked higher.
          </p>
          
          <div id="staffColumnsContainer" class="staff-columns-container">
            <div class="empty-selection" style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-secondary);border:2px dashed var(--border);border-radius:10px;">
              Select subjects first to load staff lists
            </div>
          </div>
          
          <div class="staff-actions">
            <button id="clearStaffBtn" class="staff-action-btn clear">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              Clear All Selections
            </button>
          </div>
        </div>

        <!-- Priority Mode Selector -->
        <div class="priority-mode-selector">
          <div class="priority-mode-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11l-8-8-8 8m16 0l-8 8-8-8"/>
            </svg>
            <h4>Priority Mode</h4>
            <span class="priority-badge">IMPORTANT</span>
          </div>
          
          <div class="priority-options">
            <div class="priority-option selected" onclick="selectPriority('staff')">
              <input type="radio" id="priority_staff" name="priority_mode" value="staff" class="priority-radio" checked>
              <div class="priority-info">
                <span class="priority-title">Staff First (Recommended)</span>
                <span class="priority-description">Filter sections by staff preferences first, then apply constraints. Best when you have specific faculty preferences.</span>
              </div>
            </div>
            
            <div class="priority-option" onclick="selectPriority('constraints')">
              <input type="radio" id="priority_constraints" name="priority_mode" value="constraints" class="priority-radio">
              <div class="priority-info">
                <span class="priority-title">Constraints First</span>
                <span class="priority-description">Apply time constraints first, then filter by staff preferences. Best when schedule constraints are most important.</span>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 15px; padding: 12px; background: rgba(59,130,246,0.06); border-radius: 8px; border-left: 4px solid var(--accent);">
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">
              <strong>Note:</strong> When no staff preferences are set, both modes work the same way. Staff First mode ensures your preferred faculty are prioritized.
            </p>
          </div>
        </div>

        <div class="info-box" style="background: rgba(59,130,246,0.06); border-left:4px solid var(--accent); padding:20px; border-radius:8px; margin:20px 0;">
          <h4 style="color:var(--accent); display:flex;align-items:center;gap:10px;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>About GOD MODE Search</h4>
          <ul style="padding-left:20px;color:var(--text-secondary)">
            <li>Checks 100% of all possible combinations for complete results</li>
            <li>Generation may take longer for many subjects</li>
            <li>This mode may contain ~5% flaw rate so please cross check everytime</li>
          </ul>
        </div>

        <div class="wizard-navigation">
          <button id="backToSubjects" class="wizard-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back</button>
          <button id="generateBtn" class="wizard-btn primary"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Generate Timetables</button>
        </div>

        <div id="status" class="status"></div>
      </div>
    </div>

    <!-- Results -->
    <div class="results"><div id="result"></div></div>

    <!-- Legend -->
    <div class="legend"><div class="legend-item"><div class="legend-color occupied"></div><span>Class Scheduled</span></div><div class="legend-item"><div class="legend-color empty"></div><span>No Class (Empty Slot)</span></div></div>
  </div>
<script>
    // State
    let allSubjects = []; 
    let selectedSubjects = []; 
    let filteredSubjects = [];
    let staffBySubject = new Map(); // subject code -> {subject info, staff: [{name, count, order}]}
    let dragItem = null;
    let isDragging = false;
    let staffStrictness = "flexible"; // Default: flexible mode for staff
    let constraintsStrictness = "strict"; // Default: strict mode for constraints
    
    const page1 = document.getElementById('page1');
    const page2 = document.getElementById('page2');
    const step1Circle = document.getElementById('step1Circle');
    const step2Circle = document.getElementById('step2Circle');
    const subjectSearch = document.getElementById('subjectSearch');
    let allSubjectsList = document.getElementById('allSubjectsList');
    let selectedSubjectsList = document.getElementById('selectedSubjectsList');
    const selectedCount = document.getElementById('selectedCount');
    const selectedSubjectsSummary = document.getElementById('selectedSubjectsSummary');
    const nextToPage2Btn = document.getElementById('nextToPage2');
    const backToPage1Btn = document.getElementById('backToPage1');
    const backToSubjectsBtn = document.getElementById('backToSubjects');
    const generateBtn = document.getElementById('generateBtn');
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    const staffColumnsContainer = document.getElementById('staffColumnsContainer');
    const clearStaffBtn = document.getElementById('clearStaffBtn');
    const staffStrictnessToggle = document.getElementById('staffStrictnessToggle');
    const staffStrictnessStatus = document.getElementById('staffStrictnessStatus');
    const constraintsStrictnessToggle = document.getElementById('constraintsStrictnessToggle');
    const constraintsStrictnessStatus = document.getElementById('constraintsStrictnessStatus');

    // Staff strictness toggle handler
    function updateStaffStrictness() {
      staffStrictness = staffStrictnessToggle.checked ? "strict" : "flexible";
      staffStrictnessStatus.textContent = staffStrictness.toUpperCase();
      staffStrictnessStatus.className = `staff-strictness-status ${staffStrictness}`;
      
      // Update status message
      if (staffStrictness === "strict") {
        statusDiv.textContent = 'Staff STRICT mode: Only preferred staff will be used';
        statusDiv.className = 'status warning';
      } else {
        statusDiv.textContent = 'Staff FLEXIBLE mode: Both preferred and leftover staff considered';
        statusDiv.className = 'status success';
      }
      
      setTimeout(() => {
        if (!statusDiv.className.includes('loading')) {
          statusDiv.textContent = '';
          statusDiv.className = 'status';
        }
      }, 2000);
    }
    
    // Constraints strictness toggle handler
    function updateConstraintsStrictness() {
      constraintsStrictness = constraintsStrictnessToggle.checked ? "strict" : "flexible";
      constraintsStrictnessStatus.textContent = constraintsStrictness.toUpperCase();
      constraintsStrictnessStatus.className = `constraints-toggle-status ${constraintsStrictness}`;
      
      // Update status message
      if (constraintsStrictness === "strict") {
        statusDiv.textContent = 'Constraints STRICT mode: All constraints are hard rules';
        statusDiv.className = 'status warning';
      } else {
        statusDiv.textContent = 'Constraints FLEXIBLE mode: Constraints are preferences with priority';
        statusDiv.className = 'status success';
      }
      
      setTimeout(() => {
        if (!statusDiv.className.includes('loading')) {
          statusDiv.textContent = '';
          statusDiv.className = 'status';
        }
      }, 2000);
    }
    
    // Initialize toggles
    staffStrictnessToggle.addEventListener('change', updateStaffStrictness);
    constraintsStrictnessToggle.addEventListener('change', updateConstraintsStrictness);
    
    // Initialize
    updateStaffStrictness();
    updateConstraintsStrictness();

    function selectPriority(mode) {
      // Update radio button
      document.getElementById(`priority_${mode}`).checked = true;
      
      // Update UI styling
      document.querySelectorAll('.priority-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      document.querySelector(`.priority-option[onclick="selectPriority('${mode}')"]`).classList.add('selected');
      
      // Update status message
      if (mode === 'staff') {
        statusDiv.textContent = 'Staff First mode selected';
      } else {
        statusDiv.textContent = 'Constraints First mode selected';
      }
      statusDiv.className = 'status';
      
      setTimeout(() => {
        statusDiv.textContent = '';
      }, 2000);
    }

    async function loadSubjects() {
      try {
        statusDiv.textContent = 'Loading subjects...'; statusDiv.className = 'status loading';
        const response = await fetch('/subjects');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const subjects = await response.json();
        allSubjects = subjects.filter(s => s.code !== 'ANYTHING');
        renderSubjectLists();
        statusDiv.textContent = `Loaded ${allSubjects.length} subjects`; statusDiv.className = 'status success';
        setTimeout(()=>{ statusDiv.textContent=''; statusDiv.className='status'; }, 3000);
      } catch (error) {
        console.error('Failed to load subjects:', error);
        statusDiv.textContent = 'Failed to load subjects. Is the backend running?'; statusDiv.className = 'status error';
        allSubjectsList.innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg><p>Failed to load subjects. Please check your connection.</p></div>`;
      }
    }
    let isRendering = false;
    function renderSubjectLists() {
      const searchTerm = subjectSearch.value.toLowerCase();
      filteredSubjects = allSubjects.filter(subject => {
        const matchesSearch = !searchTerm || subject.code.toLowerCase().includes(searchTerm) || subject.name.toLowerCase().includes(searchTerm);
        const isSelected = selectedSubjects.some(s => s.code === subject.code);
        return matchesSearch && !isSelected;
      });

      if (filteredSubjects.length === 0) {
        allSubjectsList.innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><p>No subjects found. Try a different search term.</p></div>`;
      } else {
        allSubjectsList.innerHTML = filteredSubjects.map(subject => `
          <div class="subject-item" data-code="${subject.code}">
            <div class="subject-info"><div class="subject-code">${subject.code}</div><div class="subject-name">${subject.name}</div></div>
            <div class="subject-sections">${subject.sections} sections</div>
          </div>
        `).join('');
      }

      if (selectedSubjects.length === 0) {
        selectedSubjectsList.innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><p>No subjects selected yet. Click on subjects from the left list to add them.</p></div>`;
      } else {
        selectedSubjectsList.innerHTML = selectedSubjects.map(subject => `
          <div class="selected-subject-item">
            <div class="subject-details"><strong>${subject.code}</strong><div style="font-size:0.9rem;color:var(--text-secondary);">${subject.name}</div></div>
            <button class="remove-subject" data-code="${subject.code}">Remove</button>
          </div>
        `).join('');
      }

      selectedCount.textContent = `(${selectedSubjects.length})`;
      updateSelectedSummary();
      
      // Load staff when subjects change
      if (selectedSubjects.length > 0) {
        loadStaffFromSubjects();
      } else {
        staffColumnsContainer.innerHTML = '<div class="empty-selection" style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-secondary);border:2px dashed var(--border);border-radius:10px;">Select subjects first to load staff lists</div>';
      }
      
    }

    async function loadStaffFromSubjects() {
      staffColumnsContainer.innerHTML = '<div class="empty-selection" style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-secondary);">Loading staff from selected subjects...</div>';
      
      // Clear existing data
      staffBySubject.clear();
      
      // Load staff for each subject
      for (const subject of selectedSubjects) {
        try {
          const res = await fetch('/staff/' + encodeURIComponent(subject.code));
          if (!res.ok) continue;
          const staffArray = await res.json();
          const staffList = [];
          const staffCounts = new Map();
          
          for (const staffName of staffArray) {
            if (staffName && staffName.trim()) {
              const name = staffName.trim();
              staffCounts.set(name, (staffCounts.get(name) || 0) + 1);
            }
          }
          
          // Convert to array of staff with counts and initialize order as 0 (not selected)
          for (const [name, count] of staffCounts) {
            staffList.push({ 
              name, 
              count,
              order: 0 // 0 means not selected/ordered
            });
          }
          
          if (staffList.length > 0) {
            staffList.sort((a, b) => a.name.localeCompare(b.name));
            staffBySubject.set(subject.code, {
              code: subject.code,
              name: subject.name,
              staff: staffList
            });
          }
        } catch (e) {
          console.error('Error loading staff for', subject.code, e);
        }
      }
      
      renderStaffColumns();
    }

    function renderStaffColumns() {
      if (staffBySubject.size === 0) {
        staffColumnsContainer.innerHTML = '<div class="empty-selection" style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-secondary);border:2px dashed var(--border);border-radius:10px;">No staff found for selected subjects</div>';
        return;
      }
      
      const columnsHTML = Array.from(staffBySubject.values()).map(subjectData => {
        // Get selected staff for this subject (order > 0)
        const selectedStaff = subjectData.staff.filter(s => s.order > 0);
        const unselectedStaff = subjectData.staff.filter(s => s.order === 0);
        
        // Sort selected staff by order
        selectedStaff.sort((a, b) => a.order - b.order);
        
        // Combine: selected first, then unselected
        const allStaffForSubject = [...selectedStaff, ...unselectedStaff];
        
        const staffHTML = allStaffForSubject.map(staff => {
          const isSelected = staff.order > 0;
          const orderBadge = isSelected ? `<div class="staff-order-badge">${staff.order}</div>` : '';
          
          return `
            <div class="staff-chip ${isSelected ? 'selected' : ''}" 
                 data-subject="${subjectData.code}"
                 data-name="${staff.name.replace(/"/g, '&quot;')}"
                 draggable="true">
              ${orderBadge}
              <div class="drag-indicator">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                </svg>
              </div>
              <div class="staff-info">
                <div class="staff-name">${staff.name}</div>
              </div>
              <div class="staff-count">${staff.count}</div>
              <button class="staff-remove" onclick="removeStaff('${staff.name.replace(/'/g, "\\'")}', '${subjectData.code}')">
                
              </button>
            </div>
          `;
        }).join('');
        
        const selectedCount = selectedStaff.length;
        
        return `
          <div class="staff-column">
            <div class="staff-column-header">
              <div class="staff-column-title">
                <span class="staff-subject-code">${subjectData.code}</span>
                <span>${subjectData.name}</span>
              </div>
              <div class="staff-column-count">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5 1.197v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <span>${selectedCount} selected</span>
              </div>
            </div>
            <div class="staff-column-content">
              <div class="staff-chips-container" id="staff-list-${subjectData.code}">
                ${staffHTML || '<div class="empty-column">No staff available for this subject</div>'}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      staffColumnsContainer.innerHTML = columnsHTML;
      
      // Add event listeners for drag and drop
      setupDragAndDrop();
    }

    function setupDragAndDrop() {
      const chips = document.querySelectorAll('.staff-chip');
      
      chips.forEach(chip => {
        chip.addEventListener('dragstart', handleDragStart);
        chip.addEventListener('dragover', handleDragOver);
        chip.addEventListener('drop', handleDrop);
        chip.addEventListener('dragend', handleDragEnd);
        
        // Also allow click to select/deselect
        chip.addEventListener('click', (e) => {
          // Don't trigger if clicking on remove button or if dragging
          if (e.target.closest('.staff-remove') || isDragging) return;
          
          const staffName = chip.dataset.name;
          const subjectCode = chip.dataset.subject;
          
          // Find the subject
          const subjectData = staffBySubject.get(subjectCode);
          if (!subjectData) return;
          
          // Find the staff in this subject
          const staff = subjectData.staff.find(s => s.name === staffName);
          if (!staff) return;
          
          if (staff.order === 0) {
            // Select this staff - give it the next available order in this subject
            const maxOrder = subjectData.staff.reduce((max, s) => Math.max(max, s.order), 0);
            staff.order = maxOrder + 1;
          } else {
            // Deselect this staff
            staff.order = 0;
            // Update order numbers for remaining selected staff in this subject
            updateOrderNumbersForSubject(subjectCode);
          }
          
          renderStaffColumns();
        });
      });
    }

    function handleDragStart(e) {
      isDragging = true;
      dragItem = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDrop(e) {
      e.stopPropagation();
      e.preventDefault();
      
      if (dragItem !== this) {
        const dragSubject = dragItem.dataset.subject;
        const dropSubject = this.dataset.subject;
        
        // Only allow dragging within the same subject column
        if (dragSubject !== dropSubject) return false;
        
        const subjectCode = dragSubject;
        const subjectData = staffBySubject.get(subjectCode);
        if (!subjectData) return false;
        
        const dragName = dragItem.dataset.name;
        const dropName = this.dataset.name;
        
        // Find the staff objects
        const dragStaff = subjectData.staff.find(s => s.name === dragName);
        const dropStaff = subjectData.staff.find(s => s.name === dropName);
        
        if (!dragStaff || !dropStaff) return false;
        
        // Only allow dragging if BOTH are selected (order > 0)
        if (dragStaff.order === 0 || dropStaff.order === 0) return false;
        
        // Swap orders
        const tempOrder = dragStaff.order;
        dragStaff.order = dropStaff.order;
        dropStaff.order = tempOrder;
        
        renderStaffColumns();
      }
      
      return false;
    }

    function handleDragEnd(e) {
      this.classList.remove('dragging');
      dragItem = null;
      isDragging = false;
    }

    function updateOrderNumbersForSubject(subjectCode) {
      const subjectData = staffBySubject.get(subjectCode);
      if (!subjectData) return;
      
      // Get selected staff for this subject
      const selectedStaff = subjectData.staff.filter(s => s.order > 0);
      
      // Sort by current order
      selectedStaff.sort((a, b) => a.order - b.order);
      
      // Reassign order numbers sequentially
      selectedStaff.forEach((staff, index) => {
        staff.order = index + 1;
      });
    }

    function removeStaff(name, subjectCode) {
      const subjectData = staffBySubject.get(subjectCode);
      if (!subjectData) return;
      
      const staff = subjectData.staff.find(s => s.name === name);
      if (staff) {
        staff.order = 0;
        updateOrderNumbersForSubject(subjectCode);
        renderStaffColumns();
      }
    }

    function updateSelectedSummary() {
      if (selectedSubjects.length === 0) {
        selectedSubjectsSummary.innerHTML = `<div style="width:100%;text-align:center;padding:20px;color:var(--text-secondary);">No subjects selected. Go back to Step 1 to add subjects.</div>`;
      } else {
        selectedSubjectsSummary.innerHTML = selectedSubjects.map(subject => `
          <div class="subject-card">${subject.code}<button class="remove-btn" data-code="${subject.code}"></button></div>
        `).join('');
      }
    }
    function attachSubjectEventListeners() {
      // clone/replace to remove old listeners
      if (allSubjectsList && allSubjectsList.parentNode) {
        const newAll = allSubjectsList.cloneNode(true);
        allSubjectsList.parentNode.replaceChild(newAll, allSubjectsList);
        allSubjectsList = document.getElementById('allSubjectsList'); // reassign
      }

      if (selectedSubjectsList && selectedSubjectsList.parentNode) {
        const newSel = selectedSubjectsList.cloneNode(true);
        selectedSubjectsList.parentNode.replaceChild(newSel, selectedSubjectsList);
        selectedSubjectsList = document.getElementById('selectedSubjectsList'); // reassign
      }

      // use event delegation on the up-to-date variables
      allSubjectsList.addEventListener('click', function(e) {
        const item = e.target.closest('.subject-item');
        if (item && !e.target.closest('.remove-subject')) {
          const code = item.dataset.code;
          const subject = allSubjects.find(s => s.code === code);
          if (subject && !selectedSubjects.some(s => s.code === code)) {
            selectedSubjects.push(subject);
            renderSubjectLists();
          }
        }
      });

      selectedSubjectsList.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-subject')) {
          const code = e.target.dataset.code;
          selectedSubjects = selectedSubjects.filter(s => s.code !== code);
          renderSubjectLists();
        }
      });
    }

    nextToPage2Btn.addEventListener('click', () => {
      if (selectedSubjects.length === 0) { statusDiv.textContent = 'Please select at least one subject to continue.'; statusDiv.className = 'status error'; setTimeout(()=>{ statusDiv.textContent=''; statusDiv.className='status'; },3000); return; }
      page1.classList.remove('active'); page1.style.display='none'; page2.classList.add('active'); page2.style.display='block'; step1Circle.classList.remove('active'); step1Circle.classList.add('completed'); step2Circle.classList.add('active'); window.scrollTo({ top:0, behavior:'smooth' });
    });

    backToPage1Btn.addEventListener('click', () => { page2.classList.remove('active'); page2.style.display='none'; page1.classList.add('active'); page1.style.display='block'; step2Circle.classList.remove('active'); step1Circle.classList.add('active'); step1Circle.classList.remove('completed'); window.scrollTo({ top:0, behavior:'smooth' }); });
    backToSubjectsBtn.addEventListener('click', () => { page2.classList.remove('active'); page2.style.display='none'; page1.classList.add('active'); page1.style.display='block'; step2Circle.classList.remove('active'); step1Circle.classList.add('active'); window.scrollTo({ top:0, behavior:'smooth' }); });

    subjectSearch.addEventListener('input', () => { renderSubjectLists(); });
    
    clearStaffBtn.addEventListener('click', () => {
      // Clear all selections from all subjects
      staffBySubject.forEach(subjectData => {
        subjectData.staff.forEach(staff => {
          staff.order = 0;
        });
      });
      renderStaffColumns();
    });

    async function generateTimetables(page = 1) {
      if (selectedSubjects.length === 0) { 
        statusDiv.textContent = 'Please select at least one subject first.'; 
        statusDiv.className = 'status error'; 
        return; 
      }
      
      // Build preferred staff list in JSON format
      let staffPreferences = [];
      
      staffBySubject.forEach((subjectData, subjectCode) => {
        // Get selected staff for this subject, sorted by order
        const selectedStaff = subjectData.staff
          .filter(staff => staff.order > 0)
          .sort((a, b) => a.order - b.order)
          .map(staff => staff.name);
        
        if (selectedStaff.length > 0) {
          staffPreferences.push({
            subject: subjectCode,
            staff: selectedStaff
          });
        }
      });
      
      // Get priority mode
      const priorityMode = document.querySelector('input[name="priority_mode"]:checked').value;
      
      // Get staff strictness from toggle
      const staffStrictnessVal = staffStrictnessToggle.checked ? "strict" : "flexible";
      
      // Get constraints strictness from toggle
      const constraintsStrictnessVal = constraintsStrictnessToggle.checked ? "strict" : "flexible";
      
      const constraints = {
        selected_subjects: selectedSubjects.map(s => s.code).join(','),
        allow_morning: document.getElementById('allow_morning').value,
        allow_evening: document.getElementById('allow_evening').value,
        allow_sat: document.getElementById('allow_sat').value,
        max_classes: document.getElementById('max_classes').value,
        need_free_day: document.getElementById('need_free_day').value,
        free_day: document.getElementById('free_day').value,
        limit: '1000',
        page: page.toString(),
        preferred_staff: JSON.stringify(staffPreferences),  // Send as JSON string
        priority_mode: priorityMode,  // Add priority mode
        staff_strictness: staffStrictnessVal,  // Add staff strictness
        constraints_strictness: constraintsStrictnessVal  // NEW: Add constraints strictness
      };

      generateBtn.disabled = true; 
      generateBtn.innerHTML = '<div class="spinner"></div> Generating...'; 
      statusDiv.textContent = page===1 ? 'Generating timetables...' : `Loading page ${page}...`; 
      statusDiv.className='status loading'; 
      
      if (page===1) {
        let modeText = priorityMode === 'staff' ? 'Staff First' : 'Constraints First';
        let staffStrictnessText = staffStrictnessVal === 'strict' ? 'STRICT' : 'FLEXIBLE';
        let constraintsStrictnessText = constraintsStrictnessVal === 'strict' ? 'STRICT' : 'FLEXIBLE';
        resultDiv.innerHTML = `
          <div style="text-align:center;padding:40px;background:#0f172a;border-radius:12px;border:1px solid #1f2937;">
            <h3 style="color:#e5e7eb;">Running Search...</h3>
            <p style="color:#9ca3af;">
              Exploring ALL possible combinations with ${modeText} priority...
              <br><strong>Staff:</strong> ${staffStrictnessText} mode
              <br><strong>Constraints:</strong> ${constraintsStrictnessText} mode
              ${staffPreferences.length > 0 ? `<br><small>Staff filtering active for ${staffPreferences.length} subjects</small>` : ''}
            </p>
          </div>
        `;
      }

      try {
        const formData = new FormData(); 
        Object.entries(constraints).forEach(([k,v]) => formData.append(k,v));
        const response = await fetch('/generate', { 
          method:'POST', 
          body: new URLSearchParams(Array.from(formData.entries())) 
        });
        
        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        const html = await response.text(); 
        resultDiv.innerHTML = html; 
        resultDiv.scrollIntoView({ behavior: 'smooth' });
        
        if (html.includes('No Valid Timetables Found')) { 
          statusDiv.textContent = 'No valid timetables found with current constraints.'; 
          statusDiv.className='status warning'; 
        } else { 
          statusDiv.textContent = page===1 ? 'Timetables generated successfully!' : `Loaded page ${page}`; 
          statusDiv.className='status success'; 
        }
      } catch (error) {
        console.error('Generation error:', error);
        resultDiv.innerHTML = `
          <div style="background:#0f172a;border-radius:12px;border:1px solid #ef4444;padding:20px;">
            <h4 style="color:#ef4444;"> Error Generating Timetables</h4>
            <p style="color:#9ca3af;">Something went wrong:</p>
            <pre style="background:#020617;padding:10px;border-radius:6px;color:#ef4444;overflow:auto;">${error.message}</pre>
            <p style="color:#9ca3af;">Check backend server and output.txt file.</p>
          </div>
        `;
        statusDiv.textContent = 'Error generating timetables'; 
        statusDiv.className='status error';
      } finally {
        generateBtn.disabled = false; 
        generateBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          Generate Timetables
        `;
        if (statusDiv.className.includes('success')) { 
          setTimeout(()=>{ 
            if (!statusDiv.className.includes('loading')) { 
              statusDiv.textContent=''; 
              statusDiv.className='status'; 
            } 
          },5000); 
        }
      }
    }

    function loadPage(page) { generateTimetables(page); }

    document.addEventListener('DOMContentLoaded', () => {
      loadSubjects();
      attachSubjectEventListeners();
      generateBtn.addEventListener('click', () => generateTimetables(1));
      subjectSearch.addEventListener('keydown', (e) => { if (e.key==='Enter') renderSubjectLists(); });
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key==='Enter' && page2.classList.contains('active')) { e.preventDefault(); if (!generateBtn.disabled) generateTimetables(1); }
        if (e.ctrlKey && e.key==='ArrowRight' && page1.classList.contains('active')) { e.preventDefault(); nextToPage2Btn.click(); }
        if (e.ctrlKey && e.key==='ArrowLeft' && page2.classList.contains('active')) { e.preventDefault(); backToPage1Btn.click(); }
      });
    });

    window.loadPage = loadPage;
    window.removeStaff = removeStaff;
    window.selectPriority = selectPriority;
  function logout() {
      // Clear the Supabase token
      document.cookie = "sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
      
      // Also clear any other auth cookies
      document.cookie = "sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
      
      // Redirect to login page
      window.location.href = "/login";
  }


</script>
</body>
</html>